<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="è´µäººçš„åšå®¢">
    <meta name="keyword" content="CUMT">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        PE Study æŒç»­æ›´æ–° - LeeHungçš„åšå®¢ | LeeHung&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> sometimes createï¼Œ sometimes work </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>JCH</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>æ ‡ç­¾</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>å­˜æ¡£</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>å…³äº</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>æœç´¢</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MS-DOS-å¤´éƒ¨"><span class="toc-text">MS-DOS å¤´éƒ¨</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PE-æ–‡ä»¶å¤´"><span class="toc-text">PE æ–‡ä»¶å¤´</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Signature"><span class="toc-text">Signature</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IMAGE-FILE-HEADERï¼š"><span class="toc-text">IMAGE_FILE_HEADERï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IMAGE-OPTIONAL-HEADERï¼š"><span class="toc-text">IMAGE_OPTIONAL_HEADERï¼š</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#åŒºå—è¡¨ï¼ˆèŠ‚è¡¨ï¼‰"><span class="toc-text">åŒºå—è¡¨ï¼ˆèŠ‚è¡¨ï¼‰</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FileOffset-RVA"><span class="toc-text">FileOffset-RVA</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ä»»æ„ä»£ç ç©ºç™½åŒºæ·»åŠ ä»£ç ï¼ˆæ–‡ä»¶æ³¨å…¥ï¼‰"><span class="toc-text">ä»»æ„ä»£ç ç©ºç™½åŒºæ·»åŠ ä»£ç ï¼ˆæ–‡ä»¶æ³¨å…¥ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#æ‰‹åŠ¨è¿‡ç¨‹ï¼š"><span class="toc-text">æ‰‹åŠ¨è¿‡ç¨‹ï¼š</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä»£ç å®ç°"><span class="toc-text">ä»£ç å®ç°</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#æ–°å¢èŠ‚"><span class="toc-text">æ–°å¢èŠ‚</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#æ‰‹åŠ¨å®ç°"><span class="toc-text">æ‰‹åŠ¨å®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä»£ç å®ç°-1"><span class="toc-text">ä»£ç å®ç°</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">æœç´¢</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> sometimes createï¼Œ sometimes work </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        PE Study æŒç»­æ›´æ–°
    </div>

    <div class="post-meta">
        <span class="attr">å‘å¸ƒäºï¼š<span>2021-02-04 22:55:57</span></span>
        
        </span>
        <span class="attr">è®¿é—®ï¼š<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <blockquote>
<p>æœ¬æ–‡å‚è€ƒåŠ å¯†è§£å¯†ç¬¬åä¸€ç« ï¼šPE æ–‡ä»¶æ ¼å¼ï¼Œå¹¶å¼•ç”¨å…¶éƒ¨åˆ†å›¾ç‰‡ã€‚</p>
</blockquote>
<p>â€‹    PE æ–‡ä»¶ä½¿ç”¨ä¸€ä¸ªå¹³é¢åœ°å€ç©ºé—´ï¼Œæ‰€æœ‰ä»£ç å’Œæ•°æ®éƒ½åˆå¹¶åœ¨ä¸€èµ·ã€‚æ–‡ä»¶å†…å®¹è¢«åˆ†å‰²ä¸ºä¸åŒçš„åŒºå— (section)ï¼Œå„ä¸ªåŒºå—æŒ‰è¾¹ç•Œå¯¹é½ã€‚æ¯ä¸ªå—éƒ½æœ‰è‡ªå·±åœ¨å†…å­˜çš„ä¸€å¥—å±æ€§ï¼Œå¦‚æ˜¯å¦åŒ…å«ä»£ç ã€æ˜¯å¦åªè¯»æˆ–å¯è¯»/å†™ã€‚åˆ†åŒºæ˜¯ä¸ºäº†èŠ‚çœç¡¬ç›˜ç©ºé—´ï¼ŒèŠ‚çœå†…å­˜ ã€‚</p>
<p>â€‹    Windows åŠ è½½å™¨éå† PE æ–‡ä»¶å†³å®šæ–‡ä»¶å“ªä¸€éƒ¨åˆ†è¢«æ˜ å°„ï¼Œå°†è¾ƒé«˜çš„åç§»ä½ç½®æ˜ å°„åˆ°è¾ƒé«˜çš„å†…å­˜åœ°å€ä¸­ã€‚ç£ç›˜æ–‡ä»¶è½½å…¥å†…å­˜ï¼Œåˆ™ç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„å¸ƒå±€å’Œå†…å­˜ä¸­çš„æ˜¯ä¸€è‡´çš„ã€‚å¯¹æ‰€æœ‰è¡¨ç°å‡ºæ¥çš„æ¶ˆæ¯ï¼Œéƒ½å…è®¸è¿›è¡Œä»ç£ç›˜é—®ä»·åˆ°å†…å­˜åç§»çš„è½¬æ¢ã€‚</p>
<p>â€‹    PE æ–‡ä»¶å†…å­˜ä¸­çš„ç‰ˆæœ¬ç§°ä¸ºæ¨¡å—ï¼ˆModuleï¼‰ã€‚æ˜ å°„æ–‡ä»¶èµ·å§‹åœ°å€ç§°ä¸ºæ¨¡å—å¥æŸ„ï¼ˆhModuleï¼‰ï¼Œå¯é€šè¿‡æ¨¡å—å¥æŸ„è®¿é—®å†…å­˜ä¸­å…¶ä»–æ•°æ®ã€‚åˆå§‹å†…å­˜åœ°å€ä¹Ÿç§°ä¸ºåŸºåœ°å€ï¼ˆImageBaseï¼‰ã€‚</p>
<p><a href="https://imgchr.com/i/ykGl1f" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/01/30/ykGl1f.png" alt="ykGl1f.png"></a></p>
<p>â€‹    æ¯ä¸ªç¨‹åºéƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿç©ºé—´ï¼Œæ¯ä¸ªè™šæ‹Ÿç©ºé—´å†…å­˜åœ°å€è¢«ç§°ä¸ºè™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ã€‚ä¸ºé¿å…å‡ºç°ç»å¯¹å†…å­˜åœ°å€å¼•å…¥ç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼ˆRVAï¼‰ï¼Œæ˜¯ç›¸å¯¹äº PE æ–‡ä»¶è½½å…¥åœ°å€çš„åç§»ä½ç½®ã€‚</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">VA</span> = ImageBase + RVA</span><br></pre></td></tr></table></figure>
<p>â€‹    PE æ–‡ä»¶å­˜å‚¨åœ¨ç£ç›˜ä¸­ï¼ŒæŸä¸ªæ•°æ®ç›¸å¯¹æ–‡ä»¶å¤´çš„åç§»é‡ç§°ä¸ºæ–‡ä»¶åç§»åœ°å€ï¼ˆFile Offsetï¼‰æˆ–ç‰©ç†åœ°å€ï¼ˆRAW Offsetï¼‰ã€‚æ¸©å»ºå¹³åç§»åœ°å€ä» PE æ–‡ä»¶ç¬¬ä¸€å­—èŠ‚å¼€å§‹è®¡æ•°ï¼Œèµ·å§‹ä¸º0ã€‚</p>
<h1 id="MS-DOS-å¤´éƒ¨"><a href="#MS-DOS-å¤´éƒ¨" class="headerlink" title="MS-DOS å¤´éƒ¨"></a>MS-DOS å¤´éƒ¨</h1><p><a href="https://imgchr.com/i/ykNDi9" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/01/30/ykNDi9.png" alt="ykNDi9.png"></a></p>
<p>e_magic å’Œ e_lfanew è¿™ä¸¤ä¸ªå­—æ®µæ¯”è¾ƒé‡è¦ã€‚e_magic è¢«è®¾ç½®ä¸º 5A4Dhï¼Œâ€œMZâ€ï¼Œæ˜¯ MS-DOS åˆ›å»ºè€…ä¹‹ä¸€åå­—ç¼©å†™ã€‚e_lfanew  å­—æ®µæ˜¯ PE  æ–‡ä»¶å¤´çš„ RVAï¼ŒæŒ‡å‡º PE å¤´çš„æ–‡ä»¶åç§»ä½ç½®ã€‚ä¹‹åæ˜¯ä¸€æ®µæ— ç”¨æ•°æ®ï¼ˆDOS STUDï¼‰ã€‚</p>
<p><a href="https://imgchr.com/i/ykUqpR" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/01/30/ykUqpR.png" alt="ykUqpR.png"></a></p>
<h1 id="PE-æ–‡ä»¶å¤´"><a href="#PE-æ–‡ä»¶å¤´" class="headerlink" title="PE æ–‡ä»¶å¤´"></a>PE æ–‡ä»¶å¤´</h1><p>â€‹    PE header æ˜¯ PE ç›¸å…³ç»“æ„ NT æ˜ åƒå¤´ï¼ˆIMAGE_NT_HEADERSï¼‰ç®€ç§°ã€‚PE è£…è½½å™¨ä»  e_lfanew å­—æ®µæ‰¾åˆ° PE header èµ·å§‹åç§»é‡ï¼ŒåŠ ä¸ŠåŸºå€å¾—åˆ° PE æ–‡ä»¶å¤´æŒ‡é’ˆã€‚</p>
<p><a href="https://imgchr.com/i/yk2uU1" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/01/30/yk2uU1.png" alt="yk2uU1.png"></a></p>
<h3 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h3><p>æœ‰æ•ˆPEæ–‡ä»¶é‡Œï¼Œè¢«è®¾ç½®ä¸º 0x00004550ï¼Œâ€œPE\0\0â€ï¼Œæ˜¯PEæ–‡ä»¶å¤´çš„å¼€å§‹ï¼Œe_lfanew  æ‰€æŒ‡å‘çš„ä½ç½®ã€‚</p>
<h3 id="IMAGE-FILE-HEADERï¼š"><a href="#IMAGE-FILE-HEADERï¼š" class="headerlink" title="IMAGE_FILE_HEADERï¼š"></a>IMAGE_FILE_HEADERï¼š</h3><p>æ˜ åƒæ–‡ä»¶å¤´ç»“æ„åŒ…å« PE æ–‡ä»¶ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œæœ€é‡è¦ä¸€ä¸ªåŸŸæŒ‡å‡ºäº† IMAGE_OPTIONAL_HEADER å¾—å¤§å°ã€‚</p>
<p><a href="https://imgchr.com/i/ykRPZd" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/01/30/ykRPZd.png" alt="ykRPZd.png"></a></p>
<p><a href="https://imgchr.com/i/yk5Dx0" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/01/30/yk5Dx0.png" alt="yk5Dx0.png"></a></p>
<ul>
<li><p>â‘  <strong>Machine</strong>ï¼šå¯æ‰§è¡Œæ–‡ä»¶ç›®æ ‡CPUç±»å‹ï¼Œ0x0 è¡¨ç¤ºä»»ä½•å¤„ç†å™¨ </p>
<p><a href="https://imgchr.com/i/ykhVRx" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/01/30/ykhVRx.png" alt="ykhVRx.png"></a></p>
</li>
<li><p>â‘¡ <strong>NumberOfSections</strong>ï¼šåŒºå—çš„æ•°ç›®ï¼Œå—è¡¨ç´§è·Ÿåœ¨ IMAGE_NT_HEADERS åé¢ã€‚</p>
</li>
<li><p>â‘¢ TimeDateStampï¼šè¡¨ç¤ºæ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ï¼Œè‡ª 1970.01.01 ç”¨ GMT è®¡ç®—çš„ç§’æ•°ï¼Œæ¯”æ–‡ä»¶ç³»ç»Ÿæ—¥æœŸæ›´ç²¾ç¡®çš„åˆ›å»ºæ—¶é—´æŒ‡ç¤ºå™¨ï¼Œç¿»è¯‘éœ€è¦ç”¨åˆ° _ctime å‡½æ•°ã€‚</p>
</li>
<li><p>â‘¥ <strong>SizeOfoptionalHeader</strong>ï¼šç´§è·Ÿåœ¨ IMAGE_FILE_HEADERSï¼Œè¡¨ç¤ºæ•°æ®å¤§å°ã€‚è¿™ä¸ªæ•°æ®ç»“æ„å«åš IMAGE_OPTINAL_HEADERï¼Œå¤§å°ä¾èµ–å½“å‰æ–‡ä»¶ 32 ä½è¿˜æ˜¯ 64 ä½æ–‡æ˜è€ƒå—ã€‚<strong>32ä½ PE æ–‡ä»¶é€šå¸¸æ˜¯ 00E0h</strong>ï¼›<strong>64ä½ PE32+ æ–‡ä»¶ï¼Œæ˜¯ 00F0h</strong>ã€‚</p>
</li>
<li><p>â‘¦ Characteristicsï¼šæ–‡ä»¶å±æ€§ï¼Œæœ‰é€‰æ‹©é€šè¿‡å‡ ä¸ªå€¼å¾—è¿ç®—å¾—åˆ°ã€‚æ™®é€š EXE æ–‡ä»¶ä¸€èˆ¬æ˜¯ 010fhï¼ŒDLL æ–‡ä»¶ä¸€èˆ¬æ˜¯ 2102hã€‚</p>
<p><a href="https://imgchr.com/i/yk4H4s" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/01/30/yk4H4s.png" alt="yk4H4s.png"></a></p>
</li>
</ul>
<h3 id="IMAGE-OPTIONAL-HEADERï¼š"><a href="#IMAGE-OPTIONAL-HEADERï¼š" class="headerlink" title="IMAGE_OPTIONAL_HEADERï¼š"></a>IMAGE_OPTIONAL_HEADERï¼š</h3><p>å¯é€‰æ˜ åƒå¤´æ˜¯ä¸€ä¸ªå¯é€‰ç»“æ„ï¼Œç”¨æ¥è¡¥è¶³å®šä¹‰ PE æ–‡ä»¶å±æ€§ï¼Œä¸å‰ä¸¤è€…è¿èµ·æ¥å°±æ˜¯ä¸€ä¸ªå®Œæ•´å¾— PE æ–‡ä»¶å¤´ç»“æ„</p>
<p><img src="https://s3.ax1x.com/2021/01/30/yASAxO.png" alt="yASAxO.png"></p>
<p><a href="https://imgchr.com/i/yAS3z8" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/01/30/yAS3z8.png" alt="yAS3z8.png"></a></p>
<ul>
<li>â‘  <strong>Magic</strong>ï¼šæ ‡è®°å­—ï¼Œè¯´æ˜æ˜¯ ROM æ˜ åƒï¼ˆ0107hï¼‰è¿˜æ˜¯æ™®é€šå¯æ‰§è¡Œæ˜ åƒï¼ˆ010Bhï¼‰ï¼Œ10B 32ä½ä¸‹çš„PEæ–‡ä»¶     20B 64ä½ä¸‹çš„PEæ–‡ä»¶ã€‚</li>
<li>â‘£ SizeOfCodeï¼šæ‰€æœ‰ä»£ç èŠ‚çš„å’Œï¼Œå¿…é¡»æ˜¯ FileAlignment çš„æ•´æ•°å€ ç¼–è¯‘å™¨å¡«çš„  æ²¡ç”¨</li>
<li>â‘¤ SizeOfInitializedDataï¼šå·²åˆå§‹åŒ–æ•°æ®å¤§å°çš„å’Œ,å¿…é¡»æ˜¯ FileAlignment çš„æ•´æ•°å€ ç¼–è¯‘å™¨å¡«çš„  æ²¡ç”¨</li>
<li>â‘¥ SizeOfUninitializedDataï¼šæœªåˆå§‹åŒ–æ•°æ®å¤§å°çš„å’Œ,å¿…é¡»æ˜¯ FileAlignment çš„æ•´æ•°å€ç¼–è¯‘å™¨å¡«çš„  æ²¡ç”¨</li>
<li>â‘¦ <strong>AddressOfEntryPointä¸‹ğŸ‡</strong>ï¼šç¨‹åºå…¥å£ OEP çš„ RVAï¼Œå¯¹äºDLLï¼Œè¿™ä¸ªå…¥å£ç‚¹åœ¨è¿›ç¨‹åˆå§‹åŒ–å’Œå…³é—­æ—¶è¢«ç›—ç”¨ã€‚æŒ‡å‘è¿è¡Œæ—¶çš„åº“ä»£ç å¹¶ç”±å®ƒæ¥è°ƒç”¨ Mainã€WinMainã€DllMain å‡½æ•°ã€‚DLL ä¸­è¢«è®¾ç½®ä¸º0ã€‚</li>
<li>â‘§ BaseOfCodeï¼šä»£ç å¼€å§‹çš„åŸºå€ï¼Œç¼–è¯‘å™¨å¡«çš„   æ²¡ç”¨</li>
<li>â‘¨ BaseOfDataï¼šæ•°æ®å¼€å§‹çš„åŸºå€ï¼Œç¼–è¯‘å™¨å¡«çš„   æ²¡ç”¨</li>
<li>â‘© <strong>ImageBase</strong>âœ¨ï¼šå†…å­˜é•œåƒåŸºå€ï¼Œé»˜è®¤ä» 400000h å¼€å§‹ï¼Œä¸å¯èƒ½æ˜¯0ï¼Œå› ä¸ºå½“æŒ‡é’ˆä¸ç”¨æ—¶å°±åº”è¯¥ä»¤å…¶æŒ‡å‘NULLï¼ˆ0ï¼‰ï¼Œè¯¥ä½ç½®æ“ä½œç³»ç»Ÿé¢„å…ˆç©ºå‡ºï¼Œè®¿é—®æ—¶ä¼šæŠ¥é”™ï¼Œæ¶‰åŠå†…å­˜ä¿æŠ¤ã€‚æœ€ä¸»è¦çš„ç›®çš„è¿˜æ˜¯æ¨¡å—å¯¹é½ã€‚</li>
<li>â‘¾ <strong>SectionAlignment</strong>ï¼šè½½å…¥å†…å­˜æ—¶çš„åŒºå—å¯¹é½å¤§å°ã€‚åœ¨ Windows 9x/Me ç”¨æˆ·æ¨¡å¼ä¸‹æœ€å°å¯¹é½å°ºå¯¸æ˜¯ 1000hã€‚</li>
<li>â‘¿ <strong>FileAlignment</strong>ï¼šç£ç›˜ä¸Š PE æ–‡ä»¶å†…åŒºå—å¯¹é½å¤§å°ã€‚200h æˆ– 1000h</li>
<li><strong>SizeOfImage</strong>ï¼šå†…å­˜ä¸­æ•´ä¸ªPEæ–‡ä»¶çš„æ˜ å°„çš„å°ºå¯¸ï¼Œå¯ä»¥æ¯”å®é™…çš„å€¼å¤§ï¼Œä½†å¿…é¡»æ˜¯SectionAlignment çš„æ•´æ•°å€</li>
<li><strong>SizeOfHeaders</strong>ï¼šæ‰€æœ‰å¤´ï¼ˆDOSã€NTï¼‰+èŠ‚è¡¨æŒ‰ç…§æ–‡ä»¶å¯¹é½åçš„æ€»å¤§å°ï¼Œä¸¥æ ¼æŒ‰ç…§ FileAlignment å¯¹é½ï¼Œå¦åˆ™åŠ è½½ä¼šå‡ºé”™</li>
<li>CheckSumï¼šæ ¡éªŒå’Œï¼Œä¸€äº›ç³»ç»Ÿæ–‡ä»¶æœ‰è¦æ±‚.ç”¨æ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹.</li>
<li>SizeOfStackReserveï¼šåˆå§‹åŒ–æ—¶ä¿ç•™çš„å †æ ˆå¤§å° </li>
<li>SizeOfStackCommitï¼šåˆå§‹åŒ–æ—¶å®é™…æäº¤çš„å¤§å° </li>
<li>SizeOfHeapReserveï¼šåˆå§‹åŒ–æ—¶ä¿ç•™çš„å †å¤§å° </li>
<li>SizeOfHeapCommitï¼šåˆå§‹åŒ–æ—¶å®è·µæäº¤çš„å¤§å° </li>
<li>NumberOfRvaAndSizesï¼šç›®å½•é¡¹æ•°ç›®ï¼Œä» Windows NT å‘å¸ƒä»¥æ¥ä¸€ç›´æ˜¯16ã€‚</li>
</ul>
<h1 id="åŒºå—è¡¨ï¼ˆèŠ‚è¡¨ï¼‰"><a href="#åŒºå—è¡¨ï¼ˆèŠ‚è¡¨ï¼‰" class="headerlink" title="åŒºå—è¡¨ï¼ˆèŠ‚è¡¨ï¼‰"></a>åŒºå—è¡¨ï¼ˆèŠ‚è¡¨ï¼‰</h1><p>â€‹    åŒºå—è¡¨ä¸­åŒ…å«æ¯ä¸ªå—åœ¨æ˜ åƒä¸­çš„ä¿¡æ¯ï¼Œåˆ†åˆ«æŒ‡å‘ä¸åŒçš„åŒºå—å®ä½“ï¼Œç›¸å½“äºèŠ‚çš„ç›®å½•ã€‚ç´§è·Ÿåœ¨ IMAGE_NT_HEADERSï¼Œæ˜¯ä¸€ä¸ª IMAGE_SECTION_HEADER ç»“æ„æ•°ç»„ã€‚æ¯ä¸ª ç»“æ„åŒ…å«äº†æ‰€å…³è”åŒºå—çš„ä¿¡æ¯ï¼Œè¯¥æ•°ç»„çš„æ•°ç›®ç”± IMAGE_NT_HEADERS.FileHeader.NumberOfSections æŒ‡å‡ºã€‚</p>
<p><a href="https://imgchr.com/i/yE2Fv8" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/01/31/yE2Fv8.png" alt="yE2Fv8.png"></a></p>
<ul>
<li><strong>Name</strong>ï¼šå—åã€‚8 ä½ ASCII ç åã€‚å¤šæ•°å—åä»¥ . å¼€å§‹ã€‚å¦‚æœè¶…è¿‡8å­—èŠ‚ï¼Œåˆ™æ²¡æœ‰æœ€åçš„ä¸­æ­¢å­—ç¬¦ NULL å­—èŠ‚ã€‚å¸¦æœ‰ $ çš„åŒååŒºå—ä¼šè¢«åˆå¹¶ï¼ŒæŒ‰å…¶åé¢çš„å­—ç¬¦çš„å­—æ¯é¡ºåºåˆå¹¶çš„ã€‚</li>
<li><strong>Misc</strong>ï¼šæŒ‡å‡ºå®é™…è¢«ä½¿ç”¨ï¼ˆå†…å­˜ä¸­ï¼‰åŒºå—å¤§å°ï¼Œæ˜¯è¿›è¡Œå¯¹é½å¤„ç†å‰åŒºå—çš„<strong>å®é™…å¤§å°</strong>ï¼Œè¯¥å€¼å¯ä»¥ä¸å‡†ç¡®ï¼Œå¯ä»»æ„ä¿®æ”¹ã€‚</li>
<li><strong>VirtualAddress</strong>ï¼šè¯¥å—è£…è½½åˆ°å†…å­˜çš„ RVAã€‚æŒ‰ç…§å†…å­˜é¡µå¯¹é½çš„ï¼Œæ€»æ˜¯  SectionAlignment çš„æ•´æ•°å€ã€‚å³åœ¨å†…å­˜ä¸­ç¦»å¤´æœ‰å¤šè¿œï¼ŒåŠ ä¸Š ImageBase æ‰æ˜¯åœ¨å†…å­˜ä¸­çœŸæ­£åœ°å€ã€‚</li>
<li><strong>SizeOfRawData</strong>ï¼šè¯¥å—åœ¨ç£ç›˜ä¸­æ‰€å çš„ç©ºé—´ã€‚åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼ŒåŒ…å« FileAlignment è°ƒæ•´çš„å—çš„é•¿åº¦ï¼Œå³åœ¨æ–‡ä»¶ä¸­<strong>å¯¹é½åçš„å¤§å°</strong>ã€‚</li>
<li><strong>PointerToRawData</strong>ï¼šè¯¥å—åœ¨ç£ç›˜æ–‡ä»¶ä¸­çš„åç§»ï¼Œå³åœ¨æ–‡ä»¶ä¸­ç¦»å¤´æœ‰å¤šè¿œ</li>
<li>PointerToRelocationsï¼šåœ¨ exe ä¸­æ— æ„ä¹‰ï¼Œåœ¨ obj æ–‡ä»¶ä¸­ä½¿ç”¨ã€‚</li>
<li>PointerToLinenumbersï¼šè¡Œå·è¡¨çš„ä½ç½®ï¼Œè°ƒè¯•çš„æ—¶å€™ä½¿ç”¨ã€‚</li>
<li>NumberOfRelocationsï¼šåœ¨ exe ä¸­æ— æ„ä¹‰ï¼Œåœ¨ obj æ–‡ä»¶ä¸­ä½¿ç”¨ã€‚</li>
<li>NumberOfLinenumbersï¼šè¡Œå·è¡¨è¡Œå·çš„æ•°é‡ï¼Œè°ƒè¯•çš„æ—¶å€™ä½¿ç”¨ã€‚</li>
<li><strong>Characteristics</strong>ï¼šåŒºå—å±æ€§</li>
</ul>
<p>p451</p>
<h1 id="FileOffset-RVA"><a href="#FileOffset-RVA" class="headerlink" title="FileOffset-RVA"></a>FileOffset-RVA</h1><p>â€‹    ç£ç›˜å¯¹é½å€¼æ˜¯ 200hï¼Œè¿™ç±»æ–‡ä»¶è¢«æ˜ å°„åˆ°å†…å­˜åï¼Œç»Ÿä¸€æ•°æ®ç›¸å¯¹äºå¤´æ–‡ä»¶çš„åç§»é‡åœ¨å†…å­˜ä¸­å’Œç£ç›˜æ–‡ä»¶ä¸­æ˜¯ä¸åŒçš„ã€‚è€Œé‚£äº›ç£ç›˜å¯¹é½å€¼ 1000h ä¸å†…å­˜é¡µç›¸åŒçš„åŒºå—ï¼Œåˆ™ä¸éœ€è¦è½¬æ¢ã€‚</p>
<p><a href="https://imgchr.com/i/y1fGjO" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/02/04/y1fGjO.png" alt="y1fGjO.png"></a></p>
<p>â€‹    Headers å’Œ SectionHeader çš„åç§»ä½ç½®ä¸å¤§å°å‡æ²¡æœ‰å˜åŒ–ï¼Œå„åŒºå—è¢«æ˜ å°„åˆ°å†…å­˜ä¸­åï¼Œåç§»ä½ç½®å°±å‘ç”Ÿäº†å˜åŒ–ã€‚è®¾ FileOffset ä¸ RVA å·®å€¼ä¸º kï¼Œåˆ™ä¸¤è€…å…³ç³»ä¸º</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">FileOffset</span>  = RVA - K</span><br><span class="line"><span class="attr">FileOffset</span> = VA - ImageBase - k</span><br></pre></td></tr></table></figure>
<p>ä»£ç å®ç° File -&gt; Image -&gt; File çš„è¿‡ç¨‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trans</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//******** FILE -&gt; FileBuffer(ptr1)********</span></span><br><span class="line">    FILE* fn = fopen(<span class="string">"C:\\Users\\leehung\\Desktop\\PE.exe"</span>,<span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">if</span>(fn==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fail to open file\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fseek(fn, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">size</span> = ftell(fn);</span><br><span class="line">    fseek(fn, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    <span class="keyword">char</span>* ptr1 = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*<span class="built_in">size</span>);</span><br><span class="line">    <span class="keyword">if</span>(ptr1==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fail to malloc FileBuffer\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(ptr1, <span class="number">0</span>, <span class="built_in">size</span>);</span><br><span class="line">    fread(ptr1, <span class="number">1</span>, <span class="built_in">size</span>, fn);</span><br><span class="line">    fclose(fn);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//********FileBuffer -&gt; ImageBuffer(ptr2)********</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDOSHeader=<span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader=<span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pImageFileHeader=<span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOPtionHeader=<span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    pDOSHeader = (PIMAGE_DOS_HEADER)ptr1;</span><br><span class="line">    <span class="keyword">if</span>(*(WORD*)ptr1 != IMAGE_DOS_SIGNATURE)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Invail DOS SIGNATURE\n"</span>);</span><br><span class="line">        <span class="built_in">free</span>(ptr1);</span><br><span class="line">        ptr1 = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)ptr1 + pDOSHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span>(*(LPDWORD)((DWORD)ptr1+pDOSHeader-&gt;e_lfanew) != IMAGE_NT_SIGNATURE)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Invail NT signature\n"</span>);</span><br><span class="line">        <span class="built_in">free</span>(ptr1);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pImageFileHeader = (PIMAGE_FILE_HEADER)((DWORD)pNTHeader+<span class="number">4</span>);</span><br><span class="line">    pOPtionHeader = (PIMAGE_OPTIONAL_HEADER32)(ptr1+pDOSHeader-&gt;e_lfanew+<span class="number">24</span>);</span><br><span class="line">    <span class="keyword">int</span> ImageSize = pOPtionHeader-&gt;SizeOfImage;</span><br><span class="line">    <span class="keyword">char</span>* ptr2 = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*ImageSize);</span><br><span class="line">    <span class="keyword">if</span>(ptr2==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fail to malloc ImageBuffer\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(ptr2, <span class="number">0</span>, ImageSize);</span><br><span class="line">    <span class="built_in">memcpy</span>(ptr2, ptr1, pOPtionHeader-&gt;SizeOfHeaders);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, *(WORD*)ptr2);</span><br><span class="line">    <span class="keyword">int</span> numSection = pImageFileHeader-&gt;NumberOfSections;</span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOPtionHeader + pImageFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; numSection; i++)&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(ptr2 + pSectionHeader-&gt;VirtualAddress, ptr1 + pSectionHeader-&gt;PointerToRawData, pSectionHeader-&gt;SizeOfRawData);</span><br><span class="line">        pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader+<span class="number">0x28</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//********ImageBuffer -&gt; NewBuffer(ptr3)********</span></span><br><span class="line">    <span class="keyword">char</span>* ptr3 = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*<span class="built_in">size</span>);</span><br><span class="line">    <span class="keyword">if</span>(ptr3==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fail to malloc FileBuffer\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(ptr3, <span class="number">0</span>, <span class="built_in">size</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(ptr3, ptr2, pOPtionHeader-&gt;SizeOfHeaders);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>,*((WORD*)ptr3));</span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOPtionHeader+pImageFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; numSection; i++)&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(ptr3 + pSectionHeader-&gt;PointerToRawData, ptr2 + pSectionHeader-&gt;VirtualAddress, pSectionHeader-&gt;SizeOfRawData);</span><br><span class="line">        pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader+<span class="number">0x28</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//********NewBuffer -&gt; file********</span></span><br><span class="line">    FILE* dst = fopen(<span class="string">"C:\\Users\\leehung\\Desktop\\1.exe"</span>,<span class="string">"wb"</span>);</span><br><span class="line">    fwrite(ptr3, <span class="number">1</span>, <span class="built_in">size</span>, dst);</span><br><span class="line">    fclose(dst);</span><br><span class="line">    <span class="built_in">free</span>(ptr1);</span><br><span class="line">    <span class="built_in">free</span>(ptr2);</span><br><span class="line">    <span class="built_in">free</span>(ptr3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ä»»æ„ä»£ç ç©ºç™½åŒºæ·»åŠ ä»£ç ï¼ˆæ–‡ä»¶æ³¨å…¥ï¼‰"><a href="#ä»»æ„ä»£ç ç©ºç™½åŒºæ·»åŠ ä»£ç ï¼ˆæ–‡ä»¶æ³¨å…¥ï¼‰" class="headerlink" title="ä»»æ„ä»£ç ç©ºç™½åŒºæ·»åŠ ä»£ç ï¼ˆæ–‡ä»¶æ³¨å…¥ï¼‰"></a>ä»»æ„ä»£ç ç©ºç™½åŒºæ·»åŠ ä»£ç ï¼ˆæ–‡ä»¶æ³¨å…¥ï¼‰</h1><blockquote>
<p>Taskï¼šå¾€ exe æ·»åŠ ä¸€æ®µä»£ç ï¼Œä½¿å…¶æ‰“å¼€ä¼šå¼¹çª—ã€‚</p>
</blockquote>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xFF15</span> <span class="keyword">CALL</span> åé¢çš„å››å­—èŠ‚æ˜¯å­˜æ”¾åœ°å€çš„åœ°å€</span><br><span class="line"><span class="number">0xFF25</span> <span class="keyword">JMP</span> åé¢çš„å››å­—èŠ‚æ˜¯å­˜æ”¾åœ°å€çš„åœ°å€</span><br><span class="line"><span class="number">0xE8</span> <span class="keyword">CALL</span> åé¢å››ä¸ªå­—èŠ‚æ˜¯åç§»</span><br><span class="line"><span class="number">0xE9</span> <span class="keyword">JMP</span> åé¢å››ä¸ªå­—èŠ‚æ˜¯åç§»</span><br><span class="line"><span class="number">0x6A</span> <span class="keyword">PUSH</span> åé¢ä¸€å­—èŠ‚</span><br></pre></td></tr></table></figure>
<p>â€‹    ç¬¬ä¸€ä¸ªèŠ‚æ˜¯ .text ä»£ç åŒºï¼Œæ·»åŠ åˆ°è¯¥èŠ‚åˆ™ä¸ç”¨ä¿®æ”¹èŠ‚å±æ€§ï¼Œå¯ç›´æ¥è¿è¡Œã€‚è‹¥éœ€è¦æ·»åŠ åˆ°åˆ«çš„èŠ‚ï¼Œåˆ™éœ€è¦ä¿®æ”¹èŠ‚å±æ€§æ‰èƒ½è¿è¡Œã€‚</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ShellCode</span></span><br><span class="line"><span class="number">6</span>A <span class="number">00</span> <span class="number">6</span>A <span class="number">00</span> <span class="number">6</span>A <span class="number">00</span> <span class="number">6</span>A <span class="number">00</span>	;å››ä¸ªpush,å‹å…¥MessageBoxå‚æ•°</span><br><span class="line">E8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>			;call</span><br><span class="line">E9 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>			;jmp</span><br></pre></td></tr></table></figure>
<p>å‡½æ•°è°ƒç”¨è¿‡ç¨‹ï¼šcall 0x78867687 -&gt; jmp 0x96786789</p>
<p>é¦–å…ˆåœ¨ OD ä¸­ bp MessageBoxAï¼Œæ‰¾åˆ°å¼¹çª—å‡½æ•°å…¥å£åœ°å€</p>
<p>x = 77D507EA(æœºå™¨ä¸­ MessageBoxA åœ°å€) - 4011AD(E8 æŒ‡ä»¤ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€) = 7794F63D</p>
<p>x2 = 00401000(æºç¨‹åºEnterPoint )-004011B2(E9 æŒ‡ä»¤ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€) = FFFFFE4E</p>
<p>EnterPoint(xä¿®æ”¹å) = 00005A0</p>
<h2 id="æ‰‹åŠ¨è¿‡ç¨‹ï¼š"><a href="#æ‰‹åŠ¨è¿‡ç¨‹ï¼š" class="headerlink" title="æ‰‹åŠ¨è¿‡ç¨‹ï¼š"></a>æ‰‹åŠ¨è¿‡ç¨‹ï¼š</h2><p>â€‹    æ‰“å¼€ç›®æ ‡ exeï¼Œå¹¶åœ¨ Winhex ä¸­æ‰“å¼€å…¶åœ¨å†…å­˜ä¸­çš„æ ¼å¼ï¼Œç”±äºæ˜¯éœ€è¦åœ¨å†…å­˜ä¸­è¿è¡Œæ—¶ä½¿å¾—æˆ‘ä»¬çš„Shellcode ç”Ÿæ•ˆï¼Œæ‰€ä»¥éœ€è¦è¿è¡Œæ—¶çš„å†…å­˜åˆ†å¸ƒæ¥è®¡ç®—å¯¹åº”çš„åç§»é‡ã€‚ä¸ç£ç›˜ä¸­çš„åŒºåˆ«ä¸ºï¼Œèµ·å§‹åœ°å€ä¸ºç³»ç»Ÿåˆ†é…çš„ ImageBaseï¼ŒPE å¤´ä¸èŠ‚ä¸èŠ‚ä¹‹é—´ä¼šè¿›è¡Œæ‹‰é•¿ã€‚</p>
<p>â€‹    åŒæ—¶æ‰“å¼€ç›®æ ‡ exe åœ¨ç£ç›˜ä¸Šçš„æ ¼å¼ï¼ŒæŸ¥çœ‹ .text èŠ‚ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„åœ°æ–¹å®¹çº³ä¸‹æˆ‘ä»¬æ·»åŠ çš„ä»£ç ï¼Œçº¢è‰²æ¡†å†…ä»¥å¡«å…¥è®¡ç®—å¥½åç§»çš„ ShellCodeã€‚</p>
<p><a href="https://imgchr.com/i/yMMl4g" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/02/03/yMMl4g.png" alt="yMMl4g.png"></a></p>
<p>â€‹    ä¹‹åå†ä¿®æ”¹æºç¨‹åº EnterPointï¼Œä½¿å…¶å€¼ä¸ºç¨‹åºåœ¨å†…å­˜ä¸­æˆ‘ä»¬ ShellCode çš„èµ·å§‹åœ°å€ï¼Œè¿™æ ·åœ¨æ‰“å¼€ exe åï¼Œç¨‹åºå°±ä¼šè‡ªåŠ¨æ‰§è¡Œæˆ‘ä»¬çš„ ShellCodeï¼Œç„¶åå†é€šè¿‡ E9 jmp æŒ‡ä»¤è·³è½¬å›åˆ°åŸæ¥ exe çš„EnterPoint ä½ç½®ï¼Œä¹‹åç¨‹åºæŒ‰åŸæ¥æƒ…å†µç»§ç»­è¿è¡Œã€‚</p>
<p><a href="https://imgchr.com/i/yMQNzd" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/02/03/yMQNzd.png" alt="yMQNzd.png"></a></p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><a href="https://imgchr.com/i/yMQ5wV" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/02/03/yMQ5wV.png" alt="yMQ5wV.png"></a></p>
<h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LenOfShellcode 0x12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MessageBoxAddr   0x75A5EE90<span class="comment">// 0x77D507EA</span></span></span><br><span class="line">BYTE Shellcode[]=</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">0x6A</span>,<span class="number">0x00</span>,<span class="number">0x6A</span>,<span class="number">0x00</span>,<span class="number">0x6A</span>,<span class="number">0x00</span>,<span class="number">0x6A</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0xE8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0xE9</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//File-&gt;FileBuffer(ptr1)</span></span><br><span class="line">    FILE* fn = fopen(<span class="string">"C:\\Users\\leehung\\Desktop\\PE.exe"</span>,<span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">if</span>(fn==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fail to open file\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fseek(fn, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">size</span> = ftell(fn);</span><br><span class="line">    fseek(fn, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    <span class="keyword">char</span>* ptr1 = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*<span class="built_in">size</span>);</span><br><span class="line">    <span class="keyword">if</span>(ptr1==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fail to malloc FileBuffer\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(ptr1, <span class="number">0</span>, <span class="built_in">size</span>);</span><br><span class="line">    fread(ptr1, <span class="number">1</span>, <span class="built_in">size</span>, fn);</span><br><span class="line">    fclose(fn);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//FileBuffer-&gt;ImageBuffer(ptr2)</span></span><br><span class="line">    PIMAGE_DOS_HEADER pDOSHeader=<span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pNTHeader=<span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_FILE_HEADER pImageFileHeader=<span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_OPTIONAL_HEADER32 pOPtionHeader=<span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pSectionHeader=<span class="literal">NULL</span>;</span><br><span class="line">    PBYTE codeBegin = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    pDOSHeader = (PIMAGE_DOS_HEADER)ptr1;</span><br><span class="line">    <span class="keyword">if</span>(*(WORD*)ptr1 != IMAGE_DOS_SIGNATURE)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Invail DOS SIGNATURE\n"</span>);</span><br><span class="line">        <span class="built_in">free</span>(ptr1);</span><br><span class="line">        ptr1 = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)ptr1 + pDOSHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span>(*(LPDWORD)((DWORD)ptr1+pDOSHeader-&gt;e_lfanew) != IMAGE_NT_SIGNATURE)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Invail NT signature\n"</span>);</span><br><span class="line">        <span class="built_in">free</span>(ptr1);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pImageFileHeader = (PIMAGE_FILE_HEADER)((DWORD)pNTHeader+<span class="number">4</span>);</span><br><span class="line">    pOPtionHeader = (PIMAGE_OPTIONAL_HEADER32)(ptr1+pDOSHeader-&gt;e_lfanew+<span class="number">24</span>);</span><br><span class="line">    <span class="keyword">int</span> ImageSize = pOPtionHeader-&gt;SizeOfImage;</span><br><span class="line">    <span class="keyword">char</span>* ptr2 = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*ImageSize);</span><br><span class="line">    <span class="keyword">if</span>(ptr2==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fail to malloc ImageBuffer\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(ptr2, <span class="number">0</span>, ImageSize);</span><br><span class="line">    <span class="built_in">memcpy</span>(ptr2, ptr1, pOPtionHeader-&gt;SizeOfHeaders);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>, *(WORD*)ptr2);</span><br><span class="line">    <span class="keyword">int</span> numSection = pImageFileHeader-&gt;NumberOfSections;</span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOPtionHeader + pImageFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; numSection; i++)&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(ptr2 + pSectionHeader-&gt;VirtualAddress, ptr1 + pSectionHeader-&gt;PointerToRawData, pSectionHeader-&gt;SizeOfRawData);</span><br><span class="line">        pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader+<span class="number">0x28</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Judge whether void space is enough to save Shellcode </span></span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOPtionHeader + pImageFileHeader-&gt;SizeOfOptionalHeader);    <span class="comment">//pSectionHeaderæŒ‡å‘ç¬¬ä¸€ä¸ªèŠ‚</span></span><br><span class="line">    <span class="keyword">if</span>(pSectionHeader-&gt;SizeOfRawData - pSectionHeader-&gt;Misc.VirtualSize &lt; LenOfShellcode)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"void space is not enough\n"</span>);</span><br><span class="line">        <span class="built_in">free</span>(ptr1);</span><br><span class="line">        <span class="built_in">free</span>(ptr2);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Insert ShellCode to .text(ImageBuffer)</span></span><br><span class="line">    pDOSHeader = (PIMAGE_DOS_HEADER)ptr2;</span><br><span class="line">    pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)ptr2 + pDOSHeader-&gt;e_lfanew);</span><br><span class="line">    pImageFileHeader = (PIMAGE_FILE_HEADER)((DWORD)pNTHeader+<span class="number">4</span>);</span><br><span class="line">    pOPtionHeader = (PIMAGE_OPTIONAL_HEADER32)(ptr2+pDOSHeader-&gt;e_lfanew+<span class="number">24</span>);</span><br><span class="line">    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOPtionHeader + pImageFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">    </span><br><span class="line">    codeBegin = (PBYTE)((DWORD)ptr2 + pSectionHeader-&gt;VirtualAddress+ pSectionHeader-&gt;Misc.VirtualSize);</span><br><span class="line">    <span class="built_in">memcpy</span>(codeBegin, Shellcode, LenOfShellcode);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fix E8 and E9 Addr and OEP</span></span><br><span class="line">    DWORD CallAddr = MessageBoxAddr - pOPtionHeader-&gt;ImageBase - (DWORD)codeBegin - <span class="number">0xD</span> + (DWORD)ptr2;</span><br><span class="line">    *(PDWORD)(codeBegin+<span class="number">0x9</span>) = CallAddr;</span><br><span class="line">    </span><br><span class="line">    DWORD JmpAddr = (pOPtionHeader-&gt;AddressOfEntryPoint + pOPtionHeader-&gt;ImageBase) - pOPtionHeader-&gt;ImageBase - (DWORD)codeBegin - <span class="number">0x12</span> + (DWORD)ptr2;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x\n"</span>,JmpAddr);</span><br><span class="line">    *(PDWORD)(codeBegin+<span class="number">0xE</span>)= JmpAddr;</span><br><span class="line">    pOPtionHeader-&gt;AddressOfEntryPoint = (DWORD)codeBegin - (DWORD)ptr2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ImageBuffer -&gt; NewBuffer</span></span><br><span class="line">    <span class="keyword">char</span>* ptr3 = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*<span class="built_in">size</span>);</span><br><span class="line">    <span class="keyword">if</span>(ptr3==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"fail to malloc FileBuffer\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(ptr3, <span class="number">0</span>, <span class="built_in">size</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(ptr3, ptr2, pOPtionHeader-&gt;SizeOfHeaders);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; numSection; i++)&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(ptr3 + pSectionHeader-&gt;PointerToRawData, ptr2 + pSectionHeader-&gt;VirtualAddress, pSectionHeader-&gt;SizeOfRawData);</span><br><span class="line">        pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pSectionHeader+<span class="number">0x28</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//********NewBuffer -&gt; file********</span></span><br><span class="line">    FILE* dst = fopen(<span class="string">"C:\\Users\\leehung\\Desktop\\1.exe"</span>,<span class="string">"wb"</span>);</span><br><span class="line">    fwrite(ptr3, <span class="number">1</span>, <span class="built_in">size</span>, dst);</span><br><span class="line">    fclose(dst);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Free </span></span><br><span class="line">    <span class="built_in">free</span>(ptr1);</span><br><span class="line">    <span class="built_in">free</span>(ptr2);</span><br><span class="line">    <span class="built_in">free</span>(ptr3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    insert();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="æ–°å¢èŠ‚"><a href="#æ–°å¢èŠ‚" class="headerlink" title="æ–°å¢èŠ‚"></a>æ–°å¢èŠ‚</h1><blockquote>
<p>Taskï¼šæ–°å¢ä¸€ä¸ªå¤§å°ä¸º1000hçš„èŠ‚</p>
</blockquote>
<h2 id="æ‰‹åŠ¨å®ç°"><a href="#æ‰‹åŠ¨å®ç°" class="headerlink" title="æ‰‹åŠ¨å®ç°"></a>æ‰‹åŠ¨å®ç°</h2><p><strong>ä¸€èˆ¬æƒ…å†µï¼š</strong></p>
<ol>
<li><p>åˆ¤æ–­æ˜¯å¦èƒ½å†™å…¥èŠ‚è¡¨ï¼Œæœ€åä¸€ä¸ªèŠ‚è¡¨ä¹‹åæœ‰ 80 å­—èŠ‚ç©ºç™½ï¼ˆä¸€ä¸ªèŠ‚è¡¨å¤§å°ä¸º40å­—èŠ‚ï¼ŒWindwosè§†å…¶ä¸ºä¸€ä¸ªç»“æ„ä½“ï¼Œå½“ä¹‹åæœ‰ç›¸åŒå¤§å°çš„ 00ï¼Œåˆ™ç³»ç»Ÿä¼šè®¤ä¸ºè¿™ä¸ªç»“æ„ä½“æ•°ç»„ç»“æŸï¼Œè¿™æ˜¯Windows é»˜è®¤è¦æ±‚ï¼‰ã€‚</p>
</li>
<li><p>å…ˆå¾€èŠ‚è¡¨æ·»åŠ èŠ‚ï¼Œä¿®æ”¹å±æ€§ä¸ºå¯æ‰§è¡Œï¼Œè¯¥æ­¥å¯ç›´æ¥å¤åˆ¶ç²˜è´´ï¼ˆWinHex ä¸­å¿«æ·é”®ä¸º Ctrl+Bï¼‰.text èŠ‚ã€‚</p>
</li>
<li><p>ä¿®æ”¹ NumberOfSections å’Œ SizeOfImageã€‚</p>
</li>
<li><p>æ–‡ä»¶æœ€åæ·»åŠ  1000h ä¸ªå­—èŠ‚</p>
</li>
<li><p>ä¿®æ”¹æ–°å¢èŠ‚è¡¨å±æ€§ï¼šVirtualAddress å¯æ ¹æ® SizeOfImage æ¥ç¡®å®šï¼ˆæˆ–è€…ç”¨æœ€åä¸€ä¸ªèŠ‚çš„VirtualAddress + Max(VirtualSize, SizeOfRawData) ç„¶åæŒ‰ 1000h å­—èŠ‚å¯¹é½ï¼‰ï¼ŒPointerToRawData å¯æ ¹æ®æœ€åä¸€ä¸ªèŠ‚çš„ PointerToRawData +  SizeOfRawData æŒ‰æ–‡ä»¶å¯¹é½å–æ•´ã€‚</p>
<p><a href="https://imgchr.com/i/ylb76I" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/02/04/ylb76I.png" alt="ylb76I.png"></a></p>
</li>
<li><p>å†™å…¥ShellCodeï¼Œå¹¶ä¿®æ­£è·³è½¬åœ°å€å’ŒOEP</p>
<p><a href="https://imgchr.com/i/y1gUfK" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2021/02/04/y1gUfK.png" alt="y1gUfK.png"></a></p>
</li>
</ol>
<p><strong>ç‰¹æ®Šæƒ…å†µï¼š</strong></p>
<p>â€‹    è‹¥åœ¨èŠ‚è¡¨åé¢ä¸ä¸ºç©ºç™½ï¼Œè€Œä¸ºç¼–è¯‘å™¨å¡«å…¥çš„ä¸€äº›æ•°æ®ï¼Œå¦‚ notepad.exeï¼Œåˆ™æ­¤æ—¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•ã€‚</p>
<p>â€‹    å¯ä»¥æ³¨æ„åˆ°é‚£æ®µ DOS STUD æ— ç”¨æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†æ•´ä¸ª NT å¤´å’ŒèŠ‚è¡¨æå‡å¹¶ä¿®æ”¹ e_lfnew æŒ‡å‘ä½ç½®å³å¯è…¾å‡ºç©ºé—´æ”¾å…¥æ–°èŠ‚ã€‚</p>
<h2 id="ä»£ç å®ç°-1"><a href="#ä»£ç å®ç°-1" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">DWORD <span class="title">Align</span><span class="params">(DWORD dwOffset, DWORD dwAlign)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// å¦‚æœåç§»å°äºå¯¹é½ï¼Œå‘ä¸Šå–æ•´</span></span><br><span class="line">	<span class="keyword">if</span> (dwOffset &lt;= dwAlign) <span class="keyword">return</span> dwAlign;</span><br><span class="line">	<span class="comment">// å¦‚æœåç§»å¤§äºå¯¹é½ä¸”ä¸èƒ½é™¤å°½ï¼Œå‘ä¸Šå–æ•´</span></span><br><span class="line">	<span class="keyword">if</span> (dwOffset % dwAlign)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> (dwOffset / dwAlign + <span class="number">1</span>) * dwAlign;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// å¦‚æœèƒ½é™¤å°½ï¼Œç›´æ¥è¿”å›offset</span></span><br><span class="line">	<span class="keyword">return</span> dwOffset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddSection</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* pFile = fopen(<span class="string">"C:\\Users\\leehung\\Desktop\\fg.exe"</span>,<span class="string">"rb"</span>);</span><br><span class="line">    <span class="keyword">if</span> (pFile == <span class="literal">NULL</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"fail to open file\n"</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    fseek(pFile, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    DWORD FileSize = ftell(pFile);</span><br><span class="line">    fseek(pFile, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    BYTE* pFileBuffer = (BYTE*)<span class="built_in">malloc</span>(FileSize);</span><br><span class="line">    <span class="keyword">if</span> (pFileBuffer == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"fail to malloc\n"</span>);</span><br><span class="line">		fclose(pFile);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    DWORD Read = fread(pFileBuffer, <span class="number">1</span>, FileSize, pFile);</span><br><span class="line">    <span class="keyword">if</span>(Read  != FileSize)</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"File size = %d\tRead into Image = %d\tFail to write\n"</span>, FileSize, Read);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer;</span><br><span class="line">	PIMAGE_NT_HEADERS pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pDosHeader + pDosHeader-&gt;e_lfanew);</span><br><span class="line">	PIMAGE_FILE_HEADER pImageFileHeader = (PIMAGE_FILE_HEADER)((DWORD)pDosHeader + pDosHeader-&gt;e_lfanew + <span class="number">4</span>);</span><br><span class="line">	PIMAGE_OPTIONAL_HEADER32 pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pImageFileHeader + <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER));</span><br><span class="line">	PIMAGE_SECTION_HEADER pSectionHeader = \</span><br><span class="line">		(PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pImageFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line"></span><br><span class="line">    PIMAGE_SECTION_HEADER pLastSectionHeader = pSectionHeader + pImageFileHeader-&gt;NumberOfSections - <span class="number">1</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER pNewSectionHeader = pSectionHeader + pImageFileHeader-&gt;NumberOfSections;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Judge whether enough to contain new SectionHeader</span></span><br><span class="line">    <span class="keyword">if</span>((DWORD)pFileBuffer + pOptionHeader-&gt;SizeOfHeaders - (DWORD)pNewSectionHeader &lt; <span class="number">80</span>)</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"æ²¡æœ‰è¶³å¤Ÿçš„80å­—èŠ‚æ’å…¥æ–°èŠ‚è¡¨\n"</span>);</span><br><span class="line">		<span class="built_in">free</span>(pFileBuffer);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//judge whether 80 bytes zero in 80 byte space</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">80</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(((BYTE*)pNewSectionHeader)[i]!=<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BYTE* pDst = (BYTE*)((DWORD)pDosHeader+<span class="keyword">sizeof</span>(IMAGE_DOS_HEADER));</span><br><span class="line">            DWORD MovSize = (DWORD)pLastSectionHeader - (DWORD)pFileBuffer + <span class="number">40</span> - (DWORD)pDosHeader-&gt;e_lfanew;</span><br><span class="line">            BYTE* pSrc = (BYTE*)<span class="built_in">malloc</span>(MovSize);</span><br><span class="line">            <span class="keyword">if</span> (pSrc == <span class="literal">NULL</span>)</span><br><span class="line">	        &#123;</span><br><span class="line">		        <span class="built_in">printf</span>(<span class="string">"åˆ†é…å†…å­˜å¤±è´¥\n"</span>);</span><br><span class="line">		        <span class="keyword">return</span>;</span><br><span class="line">	        &#125;</span><br><span class="line">            <span class="built_in">memcpy</span>(pSrc, (BYTE*)pNTHeader, MovSize);</span><br><span class="line">            <span class="built_in">memset</span>((BYTE*)pNTHeader, <span class="number">0</span>, MovSize);</span><br><span class="line">            <span class="built_in">memcpy</span>(pDst, pSrc, MovSize);</span><br><span class="line">            <span class="built_in">free</span>(pSrc);</span><br><span class="line">            pDosHeader-&gt;e_lfanew = <span class="keyword">sizeof</span>(IMAGE_DOS_HEADER);</span><br><span class="line">            DWORD surplus = (DWORD)pNTHeader-(DWORD)pDst;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"section space not enoughï¼ŒNtheader and sectionheader move forward %d byte\n"</span>, surplus);</span><br><span class="line">            <span class="keyword">if</span>(surplus &lt; <span class="number">80</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Still not 80 byte\n"</span>);</span><br><span class="line">				<span class="built_in">free</span>(pFileBuffer);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//Update Pointers</span></span><br><span class="line">            pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pDosHeader + pDosHeader-&gt;e_lfanew);</span><br><span class="line">            pImageFileHeader = (PIMAGE_FILE_HEADER)((DWORD)pDosHeader + pDosHeader-&gt;e_lfanew + <span class="number">4</span>);</span><br><span class="line">            pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pImageFileHeader + <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER));</span><br><span class="line">            pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pImageFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">            pLastSectionHeader = pSectionHeader + pImageFileHeader-&gt;NumberOfSections - <span class="number">1</span>;</span><br><span class="line">            pNewSectionHeader = pSectionHeader + pImageFileHeader-&gt;NumberOfSections;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ–°å¢ä¸€ä¸ªå¤§å°ä¸º1000hå­—èŠ‚çš„èŠ‚</span></span><br><span class="line">    IMAGE_SECTION_HEADER newSectionHeader;</span><br><span class="line">    <span class="built_in">memcpy</span>(newSectionHeader.Name, <span class="string">".newsec"</span>, <span class="number">8</span>);</span><br><span class="line">    newSectionHeader.Misc.VirtualSize = (DWORD)<span class="number">0x1000</span>;</span><br><span class="line">    newSectionHeader.VirtualAddress = pLastSectionHeader-&gt;VirtualAddress + Align(pLastSectionHeader-&gt;Misc.VirtualSize, pOptionHeader-&gt;SectionAlignment);</span><br><span class="line">    newSectionHeader.SizeOfRawData = (DWORD)<span class="number">0x1000</span>;</span><br><span class="line">    newSectionHeader.PointerToRawData = pLastSectionHeader-&gt;PointerToRawData + pLastSectionHeader-&gt;SizeOfRawData;</span><br><span class="line">    newSectionHeader.PointerToRelocations = <span class="number">0</span>;</span><br><span class="line">	newSectionHeader.PointerToLinenumbers = <span class="number">0</span>;</span><br><span class="line">	newSectionHeader.NumberOfRelocations = <span class="number">0</span>;</span><br><span class="line">	newSectionHeader.NumberOfLinenumbers = <span class="number">0</span>;</span><br><span class="line">	newSectionHeader.Characteristics = <span class="number">0x60000020</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//copy new pe with add section</span></span><br><span class="line">    BYTE* pNewFileBuffer = (BYTE*)<span class="built_in">malloc</span>(FileSize + newSectionHeader.SizeOfRawData);</span><br><span class="line">    <span class="built_in">memcpy</span>(pNewFileBuffer, pFileBuffer, FileSize);</span><br><span class="line">    <span class="built_in">memset</span>((BYTE*)((DWORD)pNewFileBuffer+FileSize), <span class="number">0</span>, newSectionHeader.SizeOfRawData);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Updata pointers</span></span><br><span class="line">    pDosHeader = (PIMAGE_DOS_HEADER)pNewFileBuffer;</span><br><span class="line">	pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pDosHeader + pDosHeader-&gt;e_lfanew);</span><br><span class="line">	pImageFileHeader = (PIMAGE_FILE_HEADER)((DWORD)pDosHeader + pDosHeader-&gt;e_lfanew + <span class="number">4</span>);</span><br><span class="line">	pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pImageFileHeader + <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER));</span><br><span class="line">	pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pImageFileHeader-&gt;SizeOfOptionalHeader);</span><br><span class="line">	pLastSectionHeader = pSectionHeader + pImageFileHeader-&gt;NumberOfSections - <span class="number">1</span>;</span><br><span class="line">	pNewSectionHeader = pSectionHeader + pImageFileHeader-&gt;NumberOfSections;</span><br><span class="line">    pImageFileHeader-&gt;NumberOfSections += <span class="number">1</span>;</span><br><span class="line">    pOptionHeader-&gt;SizeOfImage += Align(newSectionHeader.Misc.VirtualSize, pOptionHeader-&gt;SectionAlignment);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//write into NewSectionHeader</span></span><br><span class="line">    <span class="built_in">memcpy</span>(pNewSectionHeader, &amp;newSectionHeader, <span class="keyword">sizeof</span>(newSectionHeader));</span><br><span class="line">    </span><br><span class="line">    FILE* dst = fopen(<span class="string">"C:\\Users\\leehung\\Desktop\\1.exe"</span>,<span class="string">"wb"</span>);</span><br><span class="line">    <span class="keyword">if</span> (dst == <span class="literal">NULL</span>) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"fail to open file\n"</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    fwrite(pNewFileBuffer, <span class="number">1</span>, FileSize + newSectionHeader.SizeOfRawData, dst);</span><br><span class="line">    fclose(dst);</span><br><span class="line">    <span class="built_in">free</span>(pNewFileBuffer);</span><br><span class="line">    <span class="built_in">free</span>(pFileBuffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AddSection();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">è¯·æˆ‘åƒç”Ÿèš</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/img/donate.jpg">
        <p> æ„Ÿè°¢é¼“åŠ± </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

<script type="text/javascript">   
    function test(result) {    
       var referer = escape((function () { try { return top.location.href } catch (e) { return '' }})());
       var data = JSON.stringify({"referer": referer, "ip": result.ip, "address": result.address, "url": result.url.replace("#", "%23")});
       var xhr = new XMLHttpRequest();
       xhr.open('POST', 'https://cors-anywhere.herokuapp.com/http://307wve.ceye.io/blog/', true);
       xhr.setRequestHeader("Content-Type", "application/json"); 
       xhr.send(data);    
    }    
  </script>    
  <script type="text/javascript" src="https://api.asilu.com/geo/?callback=test"></script>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        
        <li>
            <a target="_blank" href="http://weibo.com/Lil_hooJC">
                            <span class="fa-stack fa-lg">
                                  <i class="iconfont icon-weibo"></i>
                            </span>
            </a>
        </li>
        

        

        
        <li>
            <a target="_blank"  href="https://github.com/LeeHun9">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://3nd.xyz">3ND</a></span>
        <span>/</span>
        
        <span><a href="https://comydream.github.io">ComyDream</a></span>
        <span>/</span>
        
        <span><a href="#">æ—ºé“ºæ‹›ç§Ÿ</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
